<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USB UVC æ‘„åƒå¤´ Web æ§åˆ¶å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00bcd4, #3d5afe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #b0bec5;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            font-size: 1.2em;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, #3d5afe 0%, #2979ff 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 50px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(61, 90, 254, 0.3);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #546e7a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button.primary {
            background: linear-gradient(135deg, #00c853 0%, #64dd17 100%);
        }

        button.danger {
            background: linear-gradient(135deg, #ff3d00 0%, #ff9100 100%);
        }

        button.warning {
            background: linear-gradient(135deg, #ff9100 0%, #ffd600 100%);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #f44336;
        }

        .status-indicator.connected {
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }

        #videoCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3d5afe;
        }

        .stat-label {
            font-size: 0.9em;
            color: #b0bec5;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
        }

        .log-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .log-entry.info {
            color: #29b6f6;
        }

        .log-entry.success {
            color: #66bb6a;
        }

        .log-entry.warning {
            color: #ffb74d;
        }

        .log-entry.error {
            color: #ef5350;
        }

        .resolution-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .resolution-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .resolution-btn:hover {
            background: rgba(61, 90, 254, 0.3);
        }

        .resolution-btn.active {
            background: #3d5afe;
            border-color: #3d5afe;
        }

        .config-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .config-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #b0bec5;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: white;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            min-width: 40px;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #b0bec5;
            font-size: 0.9em;
        }

        .compatibility-warning {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .instruction-box {
            background: rgba(0, 150, 136, 0.2);
            border: 2px solid #009688;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .instruction-box ol {
            margin-left: 20px;
            margin-top: 10px;
        }

        .instruction-box li {
            margin-bottom: 8px;
        }
    </style>
    <!-- å¼•å…¥ Canvas å¤„ç†åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jpeg-js/0.4.4/jpeg-js.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”¬ USB UVC æ‘„åƒå¤´æ§åˆ¶ä¸­å¿ƒ</h1>
            <p class="subtitle">åŸºäº WebUSB API çš„ç›´æ¥æ‘„åƒå¤´è®¿é—®æ–¹æ¡ˆ</p>
        </header>

        <div class="instruction-box">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
            <ol>
                <li>ä½¿ç”¨ <strong>Chrome/Edge 89+</strong> æµè§ˆå™¨ï¼ˆæ”¯æŒ WebUSBï¼‰</li>
                <li>è¿æ¥ USB æ‘„åƒå¤´åˆ°ç”µè„‘ï¼ˆéœ€æ”¯æŒ UVC åè®®ï¼‰</li>
                <li>ç‚¹å‡»"è¿æ¥æ‘„åƒå¤´"æŒ‰é’®é€‰æ‹©è®¾å¤‡</li>
                <li>ç‚¹å‡»"å¼€å§‹è§†é¢‘æµ"è·å–å®æ—¶ç”»é¢</li>
                <li>å¯è°ƒèŠ‚åˆ†è¾¨ç‡ã€äº®åº¦ã€å¯¹æ¯”åº¦ç­‰å‚æ•°</li>
            </ol>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§ï¼šè§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="panel">
                <div class="panel-title">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span>è§†é¢‘é¢„è§ˆ</span>
                </div>
                
                <div class="video-container">
                    <canvas id="videoCanvas"></canvas>
                    <div class="video-overlay" id="videoOverlay">
                        <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“·</div>
                        <h3 id="overlayTitle">ç­‰å¾…è¿æ¥æ‘„åƒå¤´</h3>
                        <p id="overlayMessage">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿æ¥æ‚¨çš„ USB æ‘„åƒå¤´</p>
                    </div>
                </div>

                <div class="controls-grid">
                    <button id="connectBtn" onclick="connectCamera()">
                        <span>ğŸ”Œ</span> è¿æ¥æ‘„åƒå¤´
                    </button>
                    <button id="streamBtn" onclick="toggleStream()" disabled>
                        <span>â–¶ï¸</span> å¼€å§‹è§†é¢‘æµ
                    </button>
                    <button id="captureBtn" onclick="captureImage()" disabled>
                        <span>ğŸ“¸</span> æ‹ç…§
                    </button>
                    <button id="disconnectBtn" onclick="disconnectCamera()" class="danger" disabled>
                        <span>âŒ</span> æ–­å¼€è¿æ¥
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
            <div class="panel">
                <div class="panel-title">
                    <span>âš™ï¸ æ‘„åƒå¤´æ§åˆ¶</span>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">æ‘„åƒå¤´çŠ¶æ€</div>
                        <div class="stat-value" id="cameraStatus">æœªè¿æ¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">åˆ†è¾¨ç‡</div>
                        <div class="stat-value" id="resolutionInfo">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¸§ç‡</div>
                        <div class="stat-value" id="frameRate">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç¼“å†²å¸§æ•°</div>
                        <div class="stat-value" id="bufferFrames">0</div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>åˆ†è¾¨ç‡è®¾ç½®</h3>
                    <div class="resolution-controls" id="resolutionControls">
                        <button class="resolution-btn" onclick="changeResolution(640, 480)">640Ã—480</button>
                        <button class="resolution-btn" onclick="changeResolution(800, 600)">800Ã—600</button>
                        <button class="resolution-btn" onclick="changeResolution(1024, 768)">1024Ã—768</button>
                        <button class="resolution-btn" onclick="changeResolution(1280, 720)">1280Ã—720</button>
                        <button class="resolution-btn" onclick="changeResolution(1920, 1080)">1920Ã—1080</button>
                    </div>
                </div>

                <div class="config-section">
                    <h3>å›¾åƒè®¾ç½®</h3>
                    <div class="config-group">
                        <label>äº®åº¦ <span id="brightnessValue" class="range-value">50%</span></label>
                        <input type="range" id="brightness" min="0" max="100" value="50" 
                               oninput="updateControl('brightness', this.value)">
                    </div>
                    <div class="config-group">
                        <label>å¯¹æ¯”åº¦ <span id="contrastValue" class="range-value">50%</span></label>
                        <input type="range" id="contrast" min="0" max="100" value="50" 
                               oninput="updateControl('contrast', this.value)">
                    </div>
                    <div class="config-group">
                        <label>é¥±å’Œåº¦ <span id="saturationValue" class="range-value">50%</span></label>
                        <input type="range" id="saturation" min="0" max="100" value="50" 
                               oninput="updateControl('saturation', this.value)">
                    </div>
                </div>

                <div class="config-section">
                    <h3>è§†é¢‘æ ¼å¼</h3>
                    <div class="config-group">
                        <label>é€‰æ‹©æ ¼å¼</label>
                        <select id="videoFormat" onchange="changeVideoFormat(this.value)">
                            <option value="mjpeg">MJPEGï¼ˆæ¨èï¼‰</option>
                            <option value="yuyv">YUYV</option>
                            <option value="h264">H.264</option>
                            <option value="nv12">NV12</option>
                        </select>
                    </div>
                </div>

                <button onclick="exportLogs()" class="warning" style="margin-top: 20px; width: 100%;">
                    <span>ğŸ’¾</span> å¯¼å‡ºè°ƒè¯•æ—¥å¿—
                </button>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="panel">
            <div class="panel-title">
                <span>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</span>
                <button onclick="clearLogs()" style="margin-left: auto; padding: 5px 10px; font-size: 0.8em;">
                    æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
            <div class="log-container" id="logContainer"></div>
        </div>

        <!-- å…¼å®¹æ€§è­¦å‘Š -->
        <div class="compatibility-warning" id="compatibilityWarning">
            <strong>âš ï¸ å…¼å®¹æ€§æé†’ï¼š</strong>
            <p>æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒ WebUSB APIã€‚è¯·ä½¿ç”¨ Chrome 89+ æˆ– Edge 89+ æµè§ˆå™¨ã€‚</p>
        </div>

        <footer>
            <p>åŸºäº WebUSB API çš„ UVC æ‘„åƒå¤´æ§åˆ¶ | æ”¯æŒ USB Video Class 1.5+ æ ‡å‡†</p>
            <p>æ³¨æ„ï¼šéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æˆæƒè®¿é—® USB è®¾å¤‡æƒé™</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let usbDevice = null;
        let isStreaming = false;
        let videoStreamInterval = null;
        let currentResolution = { width: 640, height: 480 };
        let frameCount = 0;
        let lastFrameTime = 0;
        let fps = 0;
        const logs = [];
        
        // DOM å…ƒç´ 
        const videoCanvas = document.getElementById('videoCanvas');
        const videoCtx = videoCanvas.getContext('2d');
        const logContainer = document.getElementById('logContainer');
        const compatibilityWarning = document.getElementById('compatibilityWarning');
        const statusIndicator = document.getElementById('statusIndicator');
        const videoOverlay = document.getElementById('videoOverlay');
        const overlayTitle = document.getElementById('overlayTitle');
        const overlayMessage = document.getElementById('overlayMessage');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½® Canvas å°ºå¯¸
            videoCanvas.width = 1280;
            videoCanvas.height = 720;
            
            // æ£€æŸ¥å…¼å®¹æ€§
            checkCompatibility();
            
            // åˆå§‹åŒ–æ—¥å¿—
            log('info', 'ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            log('info', `Canvas å°ºå¯¸: ${videoCanvas.width}Ã—${videoCanvas.height}`);
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatus();
        });

        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        function checkCompatibility() {
            if (!navigator.usb) {
                compatibilityWarning.style.display = 'block';
                log('error', 'æµè§ˆå™¨ä¸æ”¯æŒ WebUSB API');
                log('warning', 'è¯·ä½¿ç”¨ Chrome 89+ æˆ– Edge 89+ æµè§ˆå™¨');
                return false;
            }
            
            if (!window.requestAnimationFrame) {
                log('error', 'æµè§ˆå™¨ä¸æ”¯æŒ requestAnimationFrame');
                return false;
            }
            
            log('success', 'æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡');
            return true;
        }

        // è¿æ¥æ‘„åƒå¤´
        async function connectCamera() {
            if (!checkCompatibility()) {
                return;
            }
            
            try {
                log('info', 'æ­£åœ¨è¯·æ±‚ USB è®¾å¤‡è®¿é—®æƒé™...');
                
                // è¯·æ±‚ç”¨æˆ·é€‰æ‹© USB è®¾å¤‡
                usbDevice = await navigator.usb.requestDevice({
                    filters: [
                        { classCode: 0x0E, subclassCode: 0x02 }, // UVC è®¾å¤‡
                        { classCode: 0xEF, subclassCode: 0x02 }, // USB Video
                        { classCode: 0x0E } // è§†é¢‘ç±»è®¾å¤‡
                    ]
                });
                
                log('success', `æ‰¾åˆ°è®¾å¤‡: ${usbDevice.productName || 'æœªçŸ¥è®¾å¤‡'}`);
                log('info', `ä¾›åº”å•†ID: 0x${usbDevice.vendorId.toString(16)}`);
                log('info', `äº§å“ID: 0x${usbDevice.productId.toString(16)}`);
                
                // æ‰“å¼€è®¾å¤‡
                await usbDevice.open();
                log('info', 'è®¾å¤‡æ‰“å¼€æˆåŠŸ');
                
                // é€‰æ‹©é…ç½®
                await usbDevice.selectConfiguration(1);
                log('info', 'é…ç½®é€‰æ‹©æˆåŠŸ');
                
                // å£°æ˜æ¥å£
                await usbDevice.claimInterface(0);
                log('success', 'æ¥å£å£°æ˜æˆåŠŸï¼Œè®¾å¤‡å·²è¿æ¥');
                
                // æ›´æ–° UI çŠ¶æ€
                updateStatus(true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('streamBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = false;
                
                // è·å–è®¾å¤‡ä¿¡æ¯
                await getDeviceInfo();
                
            } catch (error) {
                log('error', `è¿æ¥å¤±è´¥: ${error.message}`);
                updateStatus(false);
            }
        }

        // è·å–è®¾å¤‡ä¿¡æ¯
        async function getDeviceInfo() {
            try {
                // å‘é€ UVC è·å–ä¿¡æ¯è¯·æ±‚
                const data = new Uint8Array([
                    0x80, 0x06, 0x00, 0x01, 0x00, 0x00, 0x12, 0x00
                ]);
                
                const result = await usbDevice.controlTransferIn({
                    requestType: 'vendor',
                    recipient: 'device',
                    request: 0x01,
                    value: 0x0100,
                    index: 0x0000
                }, data.length);
                
                log('info', 'è®¾å¤‡ä¿¡æ¯è·å–æˆåŠŸ');
                updateDeviceInfo(result.data);
                
            } catch (error) {
                log('warning', `è®¾å¤‡ä¿¡æ¯è·å–å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°è®¾å¤‡ä¿¡æ¯æ˜¾ç¤º
        function updateDeviceInfo(data) {
            if (data && data.byteLength > 0) {
                const decoder = new TextDecoder();
                const info = decoder.decode(data);
                log('info', `è®¾å¤‡æè¿°: ${info.substring(0, 100)}...`);
            }
        }

        // å¼€å§‹/åœæ­¢è§†é¢‘æµ
        async function toggleStream() {
            const streamBtn = document.getElementById('streamBtn');
            
            if (!isStreaming) {
                // å¼€å§‹è§†é¢‘æµ
                try {
                    log('info', 'æ­£åœ¨å¯åŠ¨è§†é¢‘æµ...');
                    
                    // è®¾ç½®è§†é¢‘æ ¼å¼å’Œåˆ†è¾¨ç‡
                    await setupVideoFormat();
                    
                    // å¼€å§‹æ¥æ”¶è§†é¢‘æ•°æ®
                    await startVideoStream();
                    
                    isStreaming = true;
                    streamBtn.innerHTML = '<span>â¸ï¸</span> åœæ­¢è§†é¢‘æµ';
                    document.getElementById('captureBtn').disabled = false;
                    
                    log('success', 'è§†é¢‘æµå·²å¯åŠ¨');
                    updateOverlay('è§†é¢‘æµè¿è¡Œä¸­', 'å®æ—¶ç”»é¢æ˜¾ç¤ºä¸­...');
                    videoOverlay.style.display = 'none';
                    
                    // å¼€å§‹ FPS è®¡ç®—
                    lastFrameTime = performance.now();
                    
                } catch (error) {
                    log('error', `å¯åŠ¨è§†é¢‘æµå¤±è´¥: ${error.message}`);
                }
            } else {
                // åœæ­¢è§†é¢‘æµ
                stopVideoStream();
                isStreaming = false;
                streamBtn.innerHTML = '<span>â–¶ï¸</span> å¼€å§‹è§†é¢‘æµ';
                document.getElementById('captureBtn').disabled = true;
                
                log('info', 'è§†é¢‘æµå·²åœæ­¢');
                updateOverlay('è§†é¢‘æµå·²åœæ­¢', 'ç‚¹å‡»å¼€å§‹æŒ‰é’®é‡æ–°å¯åŠ¨');
                videoOverlay.style.display = 'flex';
            }
        }

        // è®¾ç½®è§†é¢‘æ ¼å¼
        async function setupVideoFormat() {
            const format = document.getElementById('videoFormat').value;
            const width = currentResolution.width;
            const height = currentResolution.height;
            
            log('info', `è®¾ç½®è§†é¢‘æ ¼å¼: ${format}, åˆ†è¾¨ç‡: ${width}Ã—${height}`);
            
            // UVC åè®®ï¼šè®¾ç½®è§†é¢‘æµå‚æ•°
            // å®é™…å®ç°éœ€è¦æ ¹æ®æ‘„åƒå¤´æ”¯æŒçš„æ ¼å¼è¿›è¡Œè°ƒæ•´
            const formatConfigs = {
                'mjpeg': { guid: 'MJPEG', formatIndex: 1, frameIndex: 1 },
                'yuyv': { guid: 'YUY2', formatIndex: 1, frameIndex: 1 },
                'h264': { guid: 'H264', formatIndex: 1, frameIndex: 1 },
                'nv12': { guid: 'NV12', formatIndex: 1, frameIndex: 1 }
            };
            
            const config = formatConfigs[format] || formatConfigs.mjpeg;
            
            try {
                // è®¾ç½®è§†é¢‘æ ¼å¼
                await usbDevice.controlTransferOut({
                    requestType: 'class',
                    recipient: 'interface',
                    request: 0x01,
                    value: (config.formatIndex << 8) | 0x00,
                    index: 0x0100
                });
                
                // è®¾ç½®å¸§æ ¼å¼
                await usbDevice.controlTransferOut({
                    requestType: 'class',
                    recipient: 'interface',
                    request: 0x01,
                    value: (config.frameIndex << 8) | 0x01,
                    index: 0x0100
                });
                
                log('success', `è§†é¢‘æ ¼å¼è®¾ç½®ä¸º: ${format}`);
                
            } catch (error) {
                log('warning', `è§†é¢‘æ ¼å¼è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼: ${error.message}`);
            }
        }

        // å¼€å§‹è§†é¢‘æµ
        async function startVideoStream() {
            try {
                // UVC åè®®ï¼šå¼€å§‹è§†é¢‘æµä¼ è¾“
                await usbDevice.controlTransferOut({
                    requestType: 'class',
                    recipient: 'interface',
                    request: 0x01,
                    value: 0x0000,
                    index: 0x0200
                });
                
                log('info', 'è§†é¢‘æµæ§åˆ¶å‘½ä»¤å‘é€æˆåŠŸ');
                
                // å¼€å§‹è¯»å–è§†é¢‘æ•°æ®
                videoStreamInterval = setInterval(async () => {
                    await readVideoData();
                }, 33); // çº¦30fps
                
            } catch (error) {
                log('error', `å¯åŠ¨è§†é¢‘æµå¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // è¯»å–è§†é¢‘æ•°æ®
        async function readVideoData() {
            if (!usbDevice || !isStreaming) return;
            
            try {
                // è¯»å–è§†é¢‘æ•°æ®åŒ…
                const result = await usbDevice.transferIn(0x81, 1024 * 1024); // æœ€å¤§1MB
                
                if (result.status === 'ok' && result.data) {
                    processVideoFrame(result.data);
                    frameCount++;
                    
                    // è®¡ç®— FPS
                    const now = performance.now();
                    const delta = now - lastFrameTime;
                    
                    if (delta >= 1000) { // æ¯ç§’æ›´æ–°ä¸€æ¬¡
                        fps = Math.round((frameCount * 1000) / delta);
                        frameCount = 0;
                        lastFrameTime = now;
                        
                        // æ›´æ–°æ˜¾ç¤º
                        document.getElementById('frameRate').textContent = `${fps} FPS`;
                        document.getElementById('bufferFrames').textContent = `${Math.round(delta)}ms`;
                    }
                }
                
            } catch (error) {
                // å¿½ç•¥ä¸€äº›è¯»å–é”™è¯¯
                if (!error.message.includes('Transfer error')) {
                    log('warning', `è§†é¢‘æ•°æ®è¯»å–é”™è¯¯: ${error.message}`);
                }
            }
        }

        // å¤„ç†è§†é¢‘å¸§
        function processVideoFrame(data) {
            try {
                const format = document.getElementById('videoFormat').value;
                
                if (format === 'mjpeg') {
                    // å¤„ç† MJPEG æ•°æ®
                    processMJPEGFrame(data);
                } else {
                    // å¤„ç†åŸå§‹ YUV æ•°æ®
                    processYUYVFrame(data);
                }
                
            } catch (error) {
                log('error', `è§†é¢‘å¸§å¤„ç†å¤±è´¥: ${error.message}`);
            }
        }

        // å¤„ç† MJPEG å¸§
        function processMJPEGFrame(data) {
            try {
                // å°† Uint8Array è½¬æ¢ä¸º blob
                const blob = new Blob([data], { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                
                // åˆ›å»º Image å¯¹è±¡åŠ è½½å›¾ç‰‡
                const img = new Image();
                img.onload = () => {
                    // ç»˜åˆ¶åˆ° Canvas
                    videoCtx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
                    videoCtx.drawImage(img, 0, 0, videoCanvas.width, videoCanvas.height);
                    
                    // é‡Šæ”¾ URL
                    URL.revokeObjectURL(url);
                };
                
                img.onerror = () => {
                    log('warning', 'MJPEG å›¾åƒåŠ è½½å¤±è´¥');
                };
                
                img.src = url;
                
            } catch (error) {
                log('error', `MJPEG å¤„ç†å¤±è´¥: ${error.message}`);
            }
        }

        // å¤„ç† YUYV å¸§
        function processYUYVFrame(data) {
            // YUYV åˆ° RGB è½¬æ¢ (ç®€åŒ–ç‰ˆæœ¬)
            const width = currentResolution.width;
            const height = currentResolution.height;
            
            // åˆ›å»ºå›¾åƒæ•°æ®
            const imageData = videoCtx.createImageData(width, height);
            const pixels = imageData.data;
            
            // YUYV è½¬ RGB (è¿™é‡Œä½¿ç”¨ç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦å®Œæ•´çš„è‰²å½©ç©ºé—´è½¬æ¢)
            for (let i = 0; i < data.length; i += 4) {
                const y1 = data[i];
                const u = data[i + 1];
                const y2 = data[i + 2];
                const v = data[i + 3];
                
                // è½¬æ¢ç¬¬ä¸€ä¸ªåƒç´ 
                setRGBPixel(pixels, i, y1, u, v);
                
                // è½¬æ¢ç¬¬äºŒä¸ªåƒç´ 
                if (i + 4 < pixels.length) {
                    setRGBPixel(pixels, i + 4, y2, u, v);
                }
            }
            
            // ç»˜åˆ¶åˆ° Canvas
            videoCtx.putImageData(imageData, 0, 0);
        }

        // YUV è½¬ RGB åƒç´ è®¾ç½®
        function setRGBPixel(pixels, index, y, u, v) {
            // ç®€åŒ–çš„ YUV åˆ° RGB è½¬æ¢å…¬å¼
            const r = y + 1.402 * (v - 128);
            const g = y - 0.344136 * (u - 128) - 0.714136 * (v - 128);
            const b = y + 1.772 * (u - 128);
            
            pixels[index] = Math.max(0, Math.min(255, r));
            pixels[index + 1] = Math.max(0, Math.min(255, g));
            pixels[index + 2] = Math.max(0, Math.min(255, b));
            pixels[index + 3] = 255; // Alpha
        }

        // åœæ­¢è§†é¢‘æµ
        function stopVideoStream() {
            if (videoStreamInterval) {
                clearInterval(videoStreamInterval);
                videoStreamInterval = null;
            }
            
            if (usbDevice && isStreaming) {
                try {
                    // UVC åè®®ï¼šåœæ­¢è§†é¢‘æµ
                    usbDevice.controlTransferOut({
                        requestType: 'class',
                        recipient: 'interface',
                        request: 0x01,
                        value: 0x0000,
                        index: 0x0100
                    });
                } catch (error) {
                    log('warning', `åœæ­¢è§†é¢‘æµå‘½ä»¤å¤±è´¥: ${error.message}`);
                }
            }
            
            // æ¸…ç©º Canvas
            videoCtx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
        }

        // æ–­å¼€æ‘„åƒå¤´è¿æ¥
        async function disconnectCamera() {
            if (isStreaming) {
                stopVideoStream();
            }
            
            if (usbDevice) {
                try {
                    await usbDevice.close();
                    log('info', 'è®¾å¤‡å·²æ–­å¼€è¿æ¥');
                } catch (error) {
                    log('warning', `è®¾å¤‡æ–­å¼€å¤±è´¥: ${error.message}`);
                }
                
                usbDevice = null;
            }
            
            // é‡ç½® UI çŠ¶æ€
            updateStatus(false);
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('streamBtn').disabled = true;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('streamBtn').innerHTML = '<span>â–¶ï¸</span> å¼€å§‹è§†é¢‘æµ';
            
            // é‡ç½®æ˜¾ç¤º
            updateOverlay('è®¾å¤‡å·²æ–­å¼€', 'ç‚¹å‡»è¿æ¥æŒ‰é’®é‡æ–°è¿æ¥');
            videoOverlay.style.display = 'flex';
            
            // é‡ç½®ç»Ÿè®¡æ•°æ®
            document.getElementById('frameRate').textContent = '-';
            document.getElementById('bufferFrames').textContent = '0';
        }

        // æ‹ç…§åŠŸèƒ½
        function captureImage() {
            if (!isStreaming) {
                log('warning', 'è¯·å…ˆå¯åŠ¨è§†é¢‘æµ');
                return;
            }
            
            try {
                // ä» Canvas è·å–å›¾åƒæ•°æ®
                const imageData = videoCanvas.toDataURL('image/png');
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = `camera_capture_${Date.now()}.png`;
                link.href = imageData;
                link.click();
                
                log('success', `ç…§ç‰‡å·²ä¿å­˜: ${link.download}`);
                
            } catch (error) {
                log('error', `æ‹ç…§å¤±è´¥: ${error.message}`);
            }
        }

        // æ”¹å˜åˆ†è¾¨ç‡
        function changeResolution(width, height) {
            if (isStreaming) {
                log('warning', 'è¯·å…ˆåœæ­¢è§†é¢‘æµå†æ›´æ”¹åˆ†è¾¨ç‡');
                return;
            }
            
            currentResolution = { width, height };
            
            // æ›´æ–° Canvas å°ºå¯¸
            videoCanvas.width = width;
            videoCanvas.height = height;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('resolutionInfo').textContent = `${width}Ã—${height}`;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const buttons = document.querySelectorAll('.resolution-btn');
            buttons.forEach(btn => {
                const btnRes = btn.textContent.split('Ã—');
                const btnWidth = parseInt(btnRes[0]);
                const btnHeight = parseInt(btnRes[1]);
                
                btn.classList.toggle('active', 
                    btnWidth === width && btnHeight === height);
            });
            
            log('info', `åˆ†è¾¨ç‡å·²è®¾ç½®ä¸º: ${width}Ã—${height}`);
        }

        // æ”¹å˜è§†é¢‘æ ¼å¼
        function changeVideoFormat(format) {
            if (isStreaming) {
                log('warning', 'è¯·å…ˆåœæ­¢è§†é¢‘æµå†æ›´æ”¹è§†é¢‘æ ¼å¼');
                return;
            }
            
            log('info', `è§†é¢‘æ ¼å¼å·²åˆ‡æ¢ä¸º: ${format}`);
        }

        // æ›´æ–°æ‘„åƒå¤´æ§åˆ¶å‚æ•°
        async function updateControl(type, value) {
            if (!usbDevice) return;
            
            // æ›´æ–°æ˜¾ç¤ºå€¼
            document.getElementById(`${type}Value`).textContent = `${value}%`;
            
            try {
                // UVC åè®®ï¼šè®¾ç½®æ‘„åƒå¤´æ§åˆ¶å‚æ•°
                const controlMap = {
                    'brightness': 0x01,
                    'contrast': 0x02,
                    'saturation': 0x03
                };
                
                const controlCode = controlMap[type];
                if (controlCode) {
                    // è½¬æ¢ä¸º UVC èŒƒå›´ (é€šå¸¸ä¸º 0-255)
                    const uvcValue = Math.round(value * 2.55);
                    
                    await usbDevice.controlTransferOut({
                        requestType: 'class',
                        recipient: 'interface',
                        request: 0x01,
                        value: (uvcValue << 8) | controlCode,
                        index: 0x0200
                    });
                    
                    log('info', `${type} å·²è®¾ç½®ä¸º: ${value}%`);
                }
                
            } catch (error) {
                log('warning', `${type} è®¾ç½®å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(connected = false) {
            const statusIndicator = document.getElementById('statusIndicator');
            const cameraStatus = document.getElementById('cameraStatus');
            
            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                cameraStatus.textContent = 'å·²è¿æ¥';
                cameraStatus.style.color = '#4caf50';
            } else {
                statusIndicator.className = 'status-indicator';
                cameraStatus.textContent = 'æœªè¿æ¥';
                cameraStatus.style.color = '#f44336';
            }
        }

        // æ›´æ–°è§†é¢‘è¦†ç›–å±‚
        function updateOverlay(title, message) {
            overlayTitle.textContent = title;
            overlayMessage.textContent = message;
        }

        // æ—¥å¿—ç³»ç»Ÿ
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                level,
                message,
                id: Date.now() + Math.random()
            };
            
            logs.push(logEntry);
            
            // æ·»åŠ åˆ°æ˜¾ç¤º
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${level}`;
            logElement.innerHTML = `
                <span style="color: #999;">[${timestamp}]</span>
                <span style="margin-left: 10px;">${message}</span>
            `;
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (logs.length > 100) {
                logs.shift();
                if (logContainer.firstChild) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logs.length = 0;
            logContainer.innerHTML = '';
            log('info', 'æ—¥å¿—å·²æ¸…ç©º');
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logText = logs.map(log => 
                `[${log.timestamp}] [${log.level.toUpperCase()}] ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `camera_logs_${Date.now()}.txt`;
            link.click();
            
            URL.revokeObjectURL(url);
            log('info', 'æ—¥å¿—å·²å¯¼å‡º');
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (usbDevice || isStreaming) {
                disconnectCamera();
            }
        });

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            log('error', `æœªæ•è·çš„é”™è¯¯: ${event.message}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
            log('error', `æœªå¤„ç†çš„ Promise æ‹’ç»: ${event.reason}`);
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key.toLowerCase()) {
                    case 'c':
                        event.preventDefault();
                        if (isStreaming) captureImage();
                        break;
                    case 's':
                        event.preventDefault();
                        toggleStream();
                        break;
                    case 'd':
                        event.preventDefault();
                        disconnectCamera();
                        break;
                }
            }
        });

        // æ·»åŠ å·¥å…·æç¤º
        document.querySelectorAll('button').forEach(btn => {
            const title = btn.textContent.trim();
            btn.title = title.replace(/[ğŸ”Œâ–¶ï¸ğŸ“¸âŒâš™ï¸ğŸ’¾ğŸ“‹]/g, '').trim();
        });
    </script>
</body>
</html>
