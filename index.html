<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºUVCæ‘„åƒå¤´æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .status {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        video {
            width: 100%;
            display: block;
            background: #333;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .device-list {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .device-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .device-item:hover {
            background: #e3e3e3;
        }
        
        .device-item.active {
            background: #667eea;
            color: white;
        }
        
        .device-item .label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .device-item .id {
            font-size: 12px;
            color: #666;
            font-family: monospace;
            word-break: break-all;
        }
        
        .device-item.active .id {
            color: rgba(255,255,255,0.8);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            display: none;
            z-index: 1000;
        }
        
        .toast.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± æ‰‹æœºUVCæ‘„åƒå¤´æµ‹è¯•</h1>
            <p>è¿æ¥å¤–ç½®USBæ‘„åƒå¤´åˆ°æ‰‹æœºï¼Œæµ‹è¯•Webè®¿é—®èƒ½åŠ›</p>
            <div class="status" id="status">ç­‰å¾…è¿æ¥æ‘„åƒå¤´...</div>
        </div>
        
        <div class="content">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
            </div>
            
            <div class="controls">
                <button id="startBtn" onclick="startCamera()">
                    <span>â–¶ï¸</span> å¯åŠ¨æ‘„åƒå¤´
                </button>
                <button id="stopBtn" onclick="stopCamera()" disabled>
                    <span>â¹ï¸</span> åœæ­¢æ‘„åƒå¤´
                </button>
                <button id="snapshotBtn" onclick="takeSnapshot()" disabled>
                    <span>ğŸ“¸</span> æ‹ç…§
                </button>
                <button id="devicesBtn" onclick="listDevices()">
                    <span>ğŸ”</span> æ‰«æè®¾å¤‡
                </button>
            </div>
            
            <div id="deviceList" class="device-list" style="display: none;">
                <h3>æ£€æµ‹åˆ°çš„è§†é¢‘è®¾å¤‡ï¼š</h3>
                <div id="devicesContainer"></div>
            </div>
            
            <div id="snapshots" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentStream = null;
        let devices = [];
        let currentDeviceId = null;
        
        // æ˜¾ç¤ºæç¤º
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera(deviceId = null) {
            try {
                updateStatus('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...');
                
                // åœæ­¢ä¹‹å‰çš„æµ
                if (currentStream) {
                    stopCamera();
                }
                
                const constraints = {
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    }
                };
                
                // å¦‚æœæœ‰æŒ‡å®šè®¾å¤‡IDï¼Œä½¿ç”¨å®ƒ
                if (deviceId) {
                    constraints.video.deviceId = { exact: deviceId };
                    currentDeviceId = deviceId;
                }
                
                // å°è¯•è·å–åª’ä½“æµ
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = currentStream;
                
                // æ›´æ–°UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('snapshotBtn').disabled = false;
                
                // è·å–è®¾å¤‡ä¿¡æ¯
                const track = currentStream.getVideoTracks()[0];
                const settings = track.getSettings();
                
                updateStatus(`æ‘„åƒå¤´å·²å¯åŠ¨ - ${settings.width}x${settings.height} @ ${settings.frameRate || 'æœªçŸ¥'}fps`);
                showToast('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸï¼');
                
                // æ˜¾ç¤ºè®¾å¤‡èƒ½åŠ›
                try {
                    const capabilities = track.getCapabilities();
                    console.log('è®¾å¤‡èƒ½åŠ›:', capabilities);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å¤–ç½®æ‘„åƒå¤´ï¼ˆé€šè¿‡åˆ†è¾¨ç‡åˆ¤æ–­ï¼‰
                    if (capabilities.width && capabilities.width.max >= 1920) {
                        showToast('æ£€æµ‹åˆ°é«˜æ¸…æ‘„åƒå¤´ï¼Œå¯èƒ½æ˜¯å¤–ç½®è®¾å¤‡');
                    }
                } catch (e) {
                    console.log('æ— æ³•è·å–è®¾å¤‡èƒ½åŠ›:', e);
                }
                
            } catch (error) {
                console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
                updateStatus(`é”™è¯¯: ${error.message}`);
                showToast(`å¯åŠ¨å¤±è´¥: ${error.message}`, 5000);
                
                // å¤„ç†å¸¸è§é”™è¯¯
                if (error.name === 'NotFoundError') {
                    showToast('æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è¿æ¥', 5000);
                } else if (error.name === 'NotAllowedError') {
                    showToast('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸', 5000);
                } else if (error.name === 'NotReadableError') {
                    showToast('æ‘„åƒå¤´æ­£è¢«å…¶ä»–åº”ç”¨ä½¿ç”¨', 5000);
                }
            }
        }
        
        // åœæ­¢æ‘„åƒå¤´
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                
                const video = document.getElementById('video');
                video.srcObject = null;
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('snapshotBtn').disabled = true;
                
                updateStatus('æ‘„åƒå¤´å·²åœæ­¢');
                showToast('æ‘„åƒå¤´å·²åœæ­¢');
            }
        }
        
        // æ‹ç…§
        function takeSnapshot() {
            if (!currentStream) return;
            
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ç›¸åŒ
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.style.maxWidth = '200px';
            img.style.margin = '10px';
            img.style.border = '3px solid #667eea';
            img.style.borderRadius = '10px';
            
            // æ·»åŠ åˆ°é¡µé¢
            const snapshots = document.getElementById('snapshots');
            const container = document.createElement('div');
            container.style.display = 'inline-block';
            container.appendChild(img);
            snapshots.appendChild(container);
            
            showToast('æ‹ç…§æˆåŠŸï¼');
            
            // æä¾›ä¸‹è½½
            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `snapshot_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }, 100);
        }
        
        // åˆ—å‡ºæ‰€æœ‰è®¾å¤‡
        async function listDevices() {
            try {
                updateStatus('æ­£åœ¨æ‰«æè®¾å¤‡...');
                
                // å¿…é¡»å…ˆè·å–æƒé™æ‰èƒ½è·å–è®¾å¤‡æ ‡ç­¾
                const tempStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true,
                    audio: false 
                });
                
                // è·å–è®¾å¤‡åˆ—è¡¨
                devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // åœæ­¢ä¸´æ—¶æµ
                tempStream.getTracks().forEach(track => track.stop());
                
                // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
                const container = document.getElementById('devicesContainer');
                const deviceList = document.getElementById('deviceList');
                
                container.innerHTML = '';
                
                if (videoDevices.length === 0) {
                    container.innerHTML = '<p>æœªæ£€æµ‹åˆ°è§†é¢‘è®¾å¤‡</p>';
                } else {
                    videoDevices.forEach((device, index) => {
                        const div = document.createElement('div');
                        div.className = `device-item ${currentDeviceId === device.deviceId ? 'active' : ''}`;
                        div.onclick = () => {
                            if (currentDeviceId !== device.deviceId) {
                                startCamera(device.deviceId);
                            }
                        };
                        
                        // åˆ¤æ–­æ˜¯å¦æ˜¯å¤–ç½®æ‘„åƒå¤´
                        let deviceType = 'å†…ç½®æ‘„åƒå¤´';
                        const label = device.label.toLowerCase();
                        if (label.includes('usb') || label.includes('uvc') || 
                            label.includes('external') || label.includes('logitech')) {
                            deviceType = 'ğŸ“· å¤–ç½®USBæ‘„åƒå¤´';
                        }
                        
                        div.innerHTML = `
                            <div class="label">${deviceType} ${index + 1}</div>
                            <div class="id">${device.label || 'æœªå‘½åè®¾å¤‡'}</div>
                            <div class="id">ID: ${device.deviceId.substring(0, 50)}...</div>
                        `;
                        
                        container.appendChild(div);
                    });
                }
                
                deviceList.style.display = 'block';
                updateStatus(`æ‰¾åˆ° ${videoDevices.length} ä¸ªè§†é¢‘è®¾å¤‡`);
                showToast(`æ‰«æå®Œæˆï¼Œæ‰¾åˆ° ${videoDevices.length} ä¸ªè®¾å¤‡`);
                
            } catch (error) {
                console.error('æ‰«æè®¾å¤‡å¤±è´¥:', error);
                showToast(`æ‰«æå¤±è´¥: ${error.message}`, 5000);
                updateStatus('è®¾å¤‡æ‰«æå¤±è´¥');
            }
        }
        
        // è®¾å¤‡è¿æ¥/æ–­å¼€ç›‘å¬
        navigator.mediaDevices.addEventListener('devicechange', async () => {
            showToast('è®¾å¤‡çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°æ‰«æ...');
            await listDevices();
        });
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å…¼å®¹æ€§
        window.addEventListener('load', () => {
            updateStatus('æ­£åœ¨æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§...');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('é”™è¯¯ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®');
                showToast('è¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Safariæµè§ˆå™¨', 10000);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯HTTPSç¯å¢ƒ
            if (window.location.protocol !== 'https:' && 
                !window.location.hostname.includes('localhost')) {
                updateStatus('è­¦å‘Šï¼šéHTTPSç¯å¢ƒå¯èƒ½æ— æ³•è®¿é—®æ‘„åƒå¤´');
                showToast('å»ºè®®ä½¿ç”¨HTTPSæˆ–localhostè®¿é—®', 5000);
            }
            
            updateStatus('å°±ç»ª - ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"å¼€å§‹');
        });
        
        // é˜²æ­¢é¡µé¢å…³é—­æ—¶æœªé‡Šæ”¾æ‘„åƒå¤´
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                stopCamera();
            }
        });
    </script>
</body>
</html>
