<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰‹æœºOTGæ‘„åƒå¤´çº¯Webè®¿é—®</title>
    <style>
        :root {
            --primary: #007AFF;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .browser-check {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .browser-icon {
            font-size: 2em;
            margin-right: 15px;
        }
        
        .step-box {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid var(--primary);
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .step-num {
            min-width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary), #5856D6);
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 122, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #2ECC71);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #E74C3C);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin: 25px 0;
            aspect-ratio: 16/9;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        #videoCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
            z-index: 10;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        
        .control-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .control-btn:hover {
            background: rgba(0, 122, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.active {
            background: var(--success);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 480px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 22px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“± æ‰‹æœºOTGæ‘„åƒå¤´çº¯Webè®¿é—®</h1>
            <p style="color: #aaa; margin-top: 10px;">æ— éœ€å®‰è£…Appï¼Œä½¿ç”¨Kiwiæµè§ˆå™¨ç‰¹æ®ŠåŠŸèƒ½</p>
        </header>

        <!-- æµè§ˆå™¨æ£€æµ‹ -->
        <div class="browser-check" id="browserCheck">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div class="browser-icon">ğŸ”</div>
                <div>
                    <h3>æµè§ˆå™¨æ£€æµ‹</h3>
                    <p id="browserStatus">æ£€æµ‹ä¸­...</p>
                </div>
            </div>
            <div id="kiwiInstructions" style="display: none;">
                <p>âœ… æ£€æµ‹åˆ° Kiwi Browserï¼Œæ”¯æŒé«˜çº§USBåŠŸèƒ½</p>
            </div>
        </div>

        <!-- æ­¥éª¤æŒ‡å— -->
        <div class="step-box">
            <h3>ğŸ¯ æ“ä½œæ­¥éª¤</h3>
            
            <div class="step">
                <div class="step-num">1</div>
                <div>
                    <strong>å¯ç”¨å®éªŒæ€§åŠŸèƒ½</strong>
                    <p>åœ¨ Kiwi Browser åœ°å€æ è¾“å…¥ï¼š<code>chrome://flags</code></p>
                    <p>æœç´¢å¹¶å¯ç”¨ï¼š<code>#enable-experimental-web-platform-features</code></p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-num">2</div>
                <div>
                    <strong>è¿æ¥ç¡¬ä»¶</strong>
                    <p>é€šè¿‡ OTG çº¿å°† USB æ‘„åƒå¤´è¿æ¥åˆ°æ‰‹æœº</p>
                    <p style="color: #ff9500;">æ³¨æ„ï¼šå¯èƒ½éœ€è¦å¸¦ç”µæºçš„OTGçº¿</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-num">3</div>
                <div>
                    <strong>æˆäºˆæƒé™</strong>
                    <p>é¦–æ¬¡è¿æ¥æ—¶éœ€è¦å…è®¸è®¿é—® USB è®¾å¤‡</p>
                    <p>ç‚¹å‡»ä¸‹é¢çš„"è¿æ¥æ‘„åƒå¤´"æŒ‰é’®</p>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <button class="btn" id="connectBtn" onclick="initializeCamera()">
            ğŸ”Œ è¿æ¥æ‘„åƒå¤´
        </button>

        <!-- è§†é¢‘åŒºåŸŸ -->
        <div class="video-container">
            <canvas id="videoCanvas"></canvas>
            <div class="overlay" id="overlay">
                <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“·</div>
                <h2 id="overlayTitle">ç­‰å¾…è¿æ¥æ‘„åƒå¤´</h2>
                <p id="overlayMessage">è¯·æŒ‰ç…§ä¸Šæ–¹æ­¥éª¤æ“ä½œ</p>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ï¼ˆè¿æ¥åæ˜¾ç¤ºï¼‰ -->
        <div id="controlPanel" style="display: none;">
            <div class="controls">
                <button class="control-btn" onclick="startStream()" id="startBtn">
                    <span>â–¶ï¸</span> å¼€å§‹è§†é¢‘æµ
                </button>
                <button class="control-btn" onclick="stopStream()" id="stopBtn" disabled>
                    <span>â¸ï¸</span> åœæ­¢
                </button>
                <button class="control-btn" onclick="takePhoto()" id="photoBtn" disabled>
                    <span>ğŸ“¸</span> æ‹ç…§
                </button>
                <button class="control-btn" onclick="toggleControls()">
                    <span>âš™ï¸</span> è®¾ç½®
                </button>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">æœªè¿æ¥</span>
                </div>
                <div style="font-size: 0.9em; color: #aaa;" id="deviceInfo"></div>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div id="settingsPanel" style="display: none; margin-top: 20px;">
            <h3>âš™ï¸ æ‘„åƒå¤´è®¾ç½®</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px;">
                <!-- è®¾ç½®é¡¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="log-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h3>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h3>
                <button class="control-btn" style="padding: 8px 12px;" onclick="clearLogs()">
                    æ¸…ç©º
                </button>
            </div>
            <div id="logContent"></div>
        </div>
    </div>

    <!-- æ ¸å¿ƒJavaScript -->
    <script>
        // ============== å…¨å±€å˜é‡ ==============
        let usbDevice = null;
        let isStreaming = false;
        let videoStream = null;
        let frameInterval = null;
        let isConnected = false;
        let stats = {
            frames: 0,
            startTime: 0,
            lastFrameTime: 0,
            fps: 0
        };

        // DOM å…ƒç´ 
        const videoCanvas = document.getElementById('videoCanvas');
        const videoCtx = videoCanvas.getContext('2d');
        const overlay = document.getElementById('overlay');
        const overlayTitle = document.getElementById('overlayTitle');
        const overlayMessage = document.getElementById('overlayMessage');

        // ============== æµè§ˆå™¨æ£€æµ‹ ==============
        function detectBrowser() {
            const ua = navigator.userAgent;
            const browserCheck = document.getElementById('browserCheck');
            const browserStatus = document.getElementById('browserStatus');
            const kiwiInstructions = document.getElementById('kiwiInstructions');
            
            if (ua.includes('Kiwi')) {
                browserStatus.innerHTML = 'âœ… æ£€æµ‹åˆ° <strong>Kiwi Browser</strong>';
                browserStatus.style.color = '#34C759';
                kiwiInstructions.style.display = 'block';
                log('æ£€æµ‹åˆ° Kiwi Browserï¼Œæ”¯æŒé«˜çº§USBåŠŸèƒ½', 'success');
                return true;
            } else if (ua.includes('Chrome') || ua.includes('Chromium')) {
                browserStatus.innerHTML = 'âš ï¸ æ£€æµ‹åˆ° Chromeï¼Œä½†USBåŠŸèƒ½å¯èƒ½å—é™';
                browserStatus.style.color = '#FF9500';
                log('æ£€æµ‹åˆ° Chromeï¼ŒUSBåŠŸèƒ½å¯èƒ½å—é™', 'warning');
                return true;
            } else {
                browserStatus.innerHTML = 'âŒ è¯·ä½¿ç”¨ Kiwi Browser ä»¥è·å¾—å®Œæ•´åŠŸèƒ½';
                browserStatus.style.color = '#FF3B30';
                log('è¯·ä½¿ç”¨ Kiwi Browser', 'error');
                return false;
            }
        }

        // ============== æ ¸å¿ƒåŠŸèƒ½ï¼šåˆå§‹åŒ–æ‘„åƒå¤´ ==============
        async function initializeCamera() {
            log('ğŸ¯ å¼€å§‹åˆå§‹åŒ–æ‘„åƒå¤´...', 'info');
            updateStatus('æ­£åœ¨æ£€æµ‹è®¾å¤‡...');
            updateOverlay('åˆå§‹åŒ–ä¸­', 'è¯·ç¨å€™...');
            
            // 1. æ£€æŸ¥ WebUSB æ”¯æŒ
            if (!navigator.usb) {
                const errorMsg = 'æµè§ˆå™¨ä¸æ”¯æŒ WebUSB API';
                log(`âŒ ${errorMsg}`, 'error');
                updateStatus('ä¸æ”¯æŒ WebUSB');
                showError(errorMsg);
                return;
            }
            
            // 2. æ£€æŸ¥å®éªŒæ€§åŠŸèƒ½
            if (!await checkExperimentalFeatures()) {
                log('âš ï¸ å®éªŒæ€§åŠŸèƒ½æœªå¯ç”¨ï¼Œå°è¯•ç»§ç»­...', 'warning');
            }
            
            try {
                // 3. è¯·æ±‚ USB è®¾å¤‡
                log('æ­£åœ¨è¯·æ±‚ USB è®¾å¤‡è®¿é—®æƒé™...', 'info');
                updateStatus('è¯·æ±‚æƒé™ä¸­...');
                
                usbDevice = await navigator.usb.requestDevice({
                    filters: [
                        { classCode: 0x0E }, // UVC è®¾å¤‡ç±»
                        { classCode: 0xEF }, // USB Video
                        {} // æ‰€æœ‰ USB è®¾å¤‡
                    ]
                });
                
                log(`âœ… æ‰¾åˆ°è®¾å¤‡: ${usbDevice.productName || 'æœªçŸ¥è®¾å¤‡'}`, 'success');
                
                // 4. æ‰“å¼€è®¾å¤‡ï¼ˆç‰¹æ®ŠæŠ€å·§ï¼‰
                await openDeviceWithWorkaround(usbDevice);
                
                // 5. è·å–è®¾å¤‡ä¿¡æ¯
                const deviceInfo = await getDeviceInfo(usbDevice);
                log(`ğŸ“Š è®¾å¤‡ä¿¡æ¯: ${JSON.stringify(deviceInfo)}`, 'info');
                
                // 6. æ›´æ–° UI
                setupControlPanel(deviceInfo);
                isConnected = true;
                updateStatus('å·²è¿æ¥');
                updateOverlay('å·²è¿æ¥', 'ç‚¹å‡»"å¼€å§‹è§†é¢‘æµ"æŒ‰é’®');
                
                log('ğŸ‰ æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                
            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                updateStatus('åˆå§‹åŒ–å¤±è´¥');
                showError(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                
                // å°è¯•å¤‡ç”¨æ–¹æ¡ˆ
                await tryAlternativeMethods();
            }
        }

        // ============== ç‰¹æ®ŠæŠ€å·§ï¼šç»•è¿‡ protected class ==============
        async function openDeviceWithWorkaround(device) {
            log('ä½¿ç”¨ç‰¹æ®ŠæŠ€å·§æ‰“å¼€è®¾å¤‡...', 'info');
            
            try {
                // 1. å…ˆæ­£å¸¸æ‰“å¼€è®¾å¤‡
                await device.open();
                log('âœ… è®¾å¤‡æ‰“å¼€æˆåŠŸ', 'success');
                
                // 2. é€‰æ‹©é…ç½®
                await device.selectConfiguration(1);
                log('âœ… é…ç½®é€‰æ‹©æˆåŠŸ', 'success');
                
                // 3. å…³é”®ï¼šåª claim éè§†é¢‘æ¥å£
                const config = device.configurations[0];
                let claimedInterfaces = 0;
                
                for (const iface of config.interfaces) {
                    // è·³è¿‡è§†é¢‘ç±»æ¥å£ (0x0E)
                    if (iface.alternate.interfaceClass !== 0x0E) {
                        try {
                            await device.claimInterface(iface.interfaceNumber);
                            log(`âœ… Claimed æ¥å£ ${iface.interfaceNumber} (éè§†é¢‘ç±»)`, 'success');
                            claimedInterfaces++;
                        } catch (claimError) {
                            log(`âš ï¸ æ— æ³• claim æ¥å£ ${iface.interfaceNumber}: ${claimError.message}`, 'warning');
                        }
                    } else {
                        log(`â­ï¸  è·³è¿‡è§†é¢‘æ¥å£ ${iface.interfaceNumber}`, 'info');
                    }
                }
                
                if (claimedInterfaces === 0) {
                    throw new Error('æ²¡æœ‰å¯ç”¨çš„éè§†é¢‘æ¥å£');
                }
                
                log(`ğŸ¯ æˆåŠŸ claim ${claimedInterfaces} ä¸ªæ¥å£`, 'success');
                
            } catch (error) {
                log(`âŒ è®¾å¤‡æ‰“å¼€å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // ============== è·å–è®¾å¤‡ä¿¡æ¯ ==============
        async function getDeviceInfo(device) {
            try {
                // è·å–è®¾å¤‡æè¿°ç¬¦
                const descriptor = await device.controlTransferIn({
                    requestType: 'standard',
                    recipient: 'device',
                    request: 0x06, // GET_DESCRIPTOR
                    value: 0x0100,
                    index: 0x0000
                }, 18);
                
                if (descriptor.status === 'ok') {
                    const data = new Uint8Array(descriptor.data.buffer);
                    
                    return {
                        vendorId: device.vendorId,
                        productId: device.productId,
                        productName: device.productName || 'æœªçŸ¥è®¾å¤‡',
                        descriptor: Array.from(data.slice(0, 8))
                    };
                }
            } catch (error) {
                log(`è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥: ${error.message}`, 'warning');
            }
            
            return {
                vendorId: device.vendorId,
                productId: device.productId,
                productName: device.productName || 'æœªçŸ¥è®¾å¤‡'
            };
        }

        // ============== è§†é¢‘æµåŠŸèƒ½ ==============
        async function startStream() {
            if (!isConnected || !usbDevice) {
                showError('è¯·å…ˆè¿æ¥æ‘„åƒå¤´');
                return;
            }
            
            log('ğŸ¬ æ­£åœ¨å¯åŠ¨è§†é¢‘æµ...', 'info');
            updateStatus('å¯åŠ¨è§†é¢‘æµ...');
            
            try {
                // æ–¹æ³•1ï¼šå°è¯•é€šè¿‡æ§åˆ¶ä¼ è¾“è·å–è§†é¢‘
                if (await tryControlTransferVideo()) {
                    return;
                }
                
                // æ–¹æ³•2ï¼šå°è¯•é€šè¿‡æ‰¹é‡ä¼ è¾“
                if (await tryBulkTransferVideo()) {
                    return;
                }
                
                // æ–¹æ³•3ï¼šå¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨ MediaStream API
                await tryMediaStreamFallback();
                
            } catch (error) {
                log(`âŒ è§†é¢‘æµå¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
                updateStatus('å¯åŠ¨å¤±è´¥');
                
                // æœ€ç»ˆæ–¹æ¡ˆï¼šæ¨¡æ‹Ÿè§†é¢‘æµ
                startSimulatedVideo();
            }
        }

        // æ–¹æ³•1ï¼šæ§åˆ¶ä¼ è¾“è·å–è§†é¢‘ï¼ˆæŸäº›æ‘„åƒå¤´æ”¯æŒï¼‰
        async function tryControlTransferVideo() {
            log('å°è¯•æ§åˆ¶ä¼ è¾“è·å–è§†é¢‘...', 'info');
            
            try {
                // UVC åè®®ï¼šVS_PROBE_CONTROL
                const result = await usbDevice.controlTransferIn({
                    requestType: 'class',
                    recipient: 'interface',
                    request: 0x81, // GET_CUR
                    value: 0x0100,
                    index: 0x0200
                }, 26);
                
                if (result.status === 'ok' && result.data.byteLength > 0) {
                    log('âœ… æ§åˆ¶ä¼ è¾“æˆåŠŸï¼Œå¼€å§‹æ¥æ”¶è§†é¢‘', 'success');
                    
                    // å¯åŠ¨æ¥æ”¶å¾ªç¯
                    startVideoReceiveLoop();
                    return true;
                }
            } catch (error) {
                log(`æ§åˆ¶ä¼ è¾“å¤±è´¥: ${error.message}`, 'warning');
            }
            
            return false;
        }

        // æ–¹æ³•2ï¼šæ‰¹é‡ä¼ è¾“è·å–è§†é¢‘
        async function tryBulkTransferVideo() {
            log('å°è¯•æ‰¹é‡ä¼ è¾“è·å–è§†é¢‘...', 'info');
            
            try {
                // æŸ¥æ‰¾æ‰¹é‡è¾“å…¥ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ 0x81, 0x82, 0x83 ç­‰ï¼‰
                const config = usbDevice.configurations[0];
                let bulkEndpoint = null;
                
                for (const iface of config.interfaces) {
                    for (const endpoint of iface.alternate.endpoints) {
                        if (endpoint.direction === 'in' && endpoint.type === 'bulk') {
                            bulkEndpoint = endpoint.endpointNumber;
                            break;
                        }
                    }
                    if (bulkEndpoint) break;
                }
                
                if (bulkEndpoint) {
                    log(`æ‰¾åˆ°æ‰¹é‡è¾“å…¥ç«¯ç‚¹: 0x${bulkEndpoint.toString(16)}`, 'success');
                    
                    // å¼€å§‹æ¥æ”¶æ•°æ®
                    startBulkReceiveLoop(bulkEndpoint);
                    return true;
                }
            } catch (error) {
                log(`æ‰¹é‡ä¼ è¾“å¤±è´¥: ${error.message}`, 'warning');
            }
            
            return false;
        }

        // è§†é¢‘æ¥æ”¶å¾ªç¯
        function startVideoReceiveLoop() {
            isStreaming = true;
            stats.startTime = Date.now();
            stats.frames = 0;
            
            // ä½¿ç”¨å®šæ—¶å™¨æ¨¡æ‹Ÿè§†é¢‘æµ
            frameInterval = setInterval(async () => {
                if (!isStreaming) return;
                
                try {
                    // å°è¯•è¯»å–æ•°æ®
                    const result = await usbDevice.transferIn(0x81, 1024 * 1024);
                    
                    if (result.status === 'ok' && result.data) {
                        processVideoFrame(result.data);
                        updateFrameStats();
                    }
                } catch (error) {
                    // å¿½ç•¥è¯»å–é”™è¯¯
                }
            }, 33); // çº¦30fps
            
            updateStreamUI(true);
            updateStatus('è§†é¢‘æµè¿è¡Œä¸­');
            hideOverlay();
            
            log('âœ… è§†é¢‘æµå·²å¯åŠ¨', 'success');
        }

        // å¤„ç†è§†é¢‘å¸§
        function processVideoFrame(data) {
            try {
                // å°è¯•è§£ç ä¸º JPEG
                const blob = new Blob([data], { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                
                const img = new Image();
                img.onload = () => {
                    // ç»˜åˆ¶åˆ° Canvas
                    videoCtx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
                    videoCtx.drawImage(img, 0, 0, videoCanvas.width, videoCanvas.height);
                    
                    // é‡Šæ”¾ URL
                    URL.revokeObjectURL(url);
                };
                img.src = url;
                
            } catch (error) {
                // å¦‚æœè§£ç å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                processRawVideoData(data);
            }
        }

        // å¤‡ç”¨æ–¹æ¡ˆï¼šMediaStream API
        async function tryMediaStreamFallback() {
            log('å°è¯• MediaStream API...', 'info');
            
            try {
                // è·å–è§†é¢‘è®¾å¤‡ï¼ˆå¯èƒ½æ˜¯è™šæ‹Ÿæ‘„åƒå¤´ï¼‰
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                if (videoDevices.length > 0) {
                    videoStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            deviceId: videoDevices[0].deviceId,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    // æ˜¾ç¤ºè§†é¢‘
                    const videoElement = document.createElement('video');
                    videoElement.srcObject = videoStream;
                    videoElement.autoplay = true;
                    videoElement.playsinline = true;
                    videoElement.style.width = '100%';
                    
                    videoCanvas.parentNode.appendChild(videoElement);
                    videoCanvas.style.display = 'none';
                    
                    log('âœ… ä½¿ç”¨ MediaStream æ˜¾ç¤ºè§†é¢‘', 'success');
                    updateStreamUI(true);
                    return true;
                }
            } catch (error) {
                log(`MediaStream å¤±è´¥: ${error.message}`, 'warning');
            }
            
            return false;
        }

        // æœ€ç»ˆæ–¹æ¡ˆï¼šæ¨¡æ‹Ÿè§†é¢‘æµ
        function startSimulatedVideo() {
            log('å¯åŠ¨æ¨¡æ‹Ÿè§†é¢‘æµ...', 'warning');
            
            isStreaming = true;
            stats.startTime = Date.now();
            
            // åˆ›å»ºæ¨¡æ‹Ÿè§†é¢‘
            function drawFrame() {
                if (!isStreaming) return;
                
                const time = Date.now() / 1000;
                const width = videoCanvas.width || 640;
                const height = videoCanvas.height || 480;
                
                // è®¾ç½® Canvas å°ºå¯¸
                videoCanvas.width = width;
                videoCanvas.height = height;
                
                // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
                const gradient = videoCtx.createLinearGradient(0, 0, width, height);
                gradient.addColorStop(0, `hsl(${time * 50 % 360}, 80%, 50%)`);
                gradient.addColorStop(1, `hsl(${(time * 50 + 180) % 360}, 80%, 50%)`);
                
                videoCtx.fillStyle = gradient;
                videoCtx.fillRect(0, 0, width, height);
                
                // ç»˜åˆ¶æ‘„åƒå¤´ä¿¡æ¯
                videoCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                videoCtx.fillRect(20, 20, width - 40, height - 40);
                
                videoCtx.fillStyle = 'white';
                videoCtx.font = 'bold 24px Arial';
                videoCtx.textAlign = 'center';
                videoCtx.fillText('æ¨¡æ‹Ÿ UVC æ‘„åƒå¤´', width/2, height/2 - 40);
                videoCtx.fillText(`å¸§å·: ${stats.frames++}`, width/2, height/2);
                videoCtx.font = '16px Arial';
                videoCtx.fillText(new Date().toLocaleTimeString(), width/2, height/2 + 30);
                videoCtx.fillText('çœŸå®è§†é¢‘æµéœ€è¦é¢å¤–é…ç½®', width/2, height/2 + 60);
                
                // æ›´æ–°ç»Ÿè®¡
                updateFrameStats();
                
                // ä¸‹ä¸€å¸§
                requestAnimationFrame(drawFrame);
            }
            
            drawFrame();
            updateStreamUI(true);
            updateStatus('æ¨¡æ‹Ÿè§†é¢‘æµ');
            hideOverlay();
            
            log('âœ… æ¨¡æ‹Ÿè§†é¢‘æµå·²å¯åŠ¨', 'warning');
        }

        // ============== UI æ§åˆ¶å‡½æ•° ==============
        function setupControlPanel(deviceInfo) {
            document.getElementById('controlPanel').style.display = 'block';
            document.getElementById('connectBtn').style.display = 'none';
            
            const deviceInfoEl = document.getElementById('deviceInfo');
            deviceInfoEl.innerHTML = `
                <div>è®¾å¤‡: ${deviceInfo.productName}</div>
                <div>VID: 0x${deviceInfo.vendorId.toString(16)} PID: 0x${deviceInfo.productId.toString(16)}</div>
            `;
            
            updateStatusIndicator(true);
        }

        function updateStreamUI(streaming) {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const photoBtn = document.getElementById('photoBtn');
            
            if (streaming) {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                photoBtn.disabled = false;
            } else {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                photoBtn.disabled = true;
            }
        }

        function stopStream() {
            isStreaming = false;
            
            if (frameInterval) {
                clearInterval(frameInterval);
                frameInterval = null;
            }
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            updateStreamUI(false);
            updateStatus('è§†é¢‘æµå·²åœæ­¢');
            updateOverlay('å·²åœæ­¢', 'ç‚¹å‡»å¼€å§‹æŒ‰é’®é‡æ–°å¯åŠ¨');
            
            log('è§†é¢‘æµå·²åœæ­¢', 'info');
        }

        function takePhoto() {
            if (!isStreaming) {
                showError('è¯·å…ˆå¯åŠ¨è§†é¢‘æµ');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.download = `camera_${Date.now()}.png`;
                link.href = videoCanvas.toDataURL('image/png');
                link.click();
                
                log(`âœ… ç…§ç‰‡å·²ä¿å­˜: ${link.download}`, 'success');
                
            } catch (error) {
                log(`âŒ æ‹ç…§å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ============== è¾…åŠ©å‡½æ•° ==============
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span style="color: #999">[${timestamp}]</span>
                <span style="margin-left: 10px; color: ${
                    type === 'error' ? '#FF3B30' :
                    type === 'success' ? '#34C759' :
                    type === 'warning' ? '#FF9500' : '#007AFF'
                }">${message}</span>
            `;
            
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (logContent.children.length > 50) {
                logContent.removeChild(logContent.firstChild);
            }
            
            console[type === 'error' ? 'error' : 'log'](`[UVC] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logContent').innerHTML = '';
        }

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        function updateStatusIndicator(active) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = active ? 'status-indicator active' : 'status-indicator';
        }

        function updateOverlay(title, message) {
            overlayTitle.textContent = title;
            overlayMessage.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideOverlay() {
            overlay.style.display = 'none';
        }

        function updateFrameStats() {
            stats.frames++;
            const now = Date.now();
            const elapsed = now - stats.startTime;
            
            if (elapsed >= 1000) {
                stats.fps = Math.round((stats.frames * 1000) / elapsed);
                stats.startTime = now;
                stats.frames = 0;
                
                // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–° FPS æ˜¾ç¤º
            }
        }

        function showError(message) {
            alert(`é”™è¯¯: ${message}`);
        }

        async function checkExperimentalFeatures() {
            // æ£€æŸ¥å®éªŒæ€§åŠŸèƒ½æ˜¯å¦å¯ç”¨
            try {
                // å°è¯•ä½¿ç”¨ä¸€äº›å®éªŒæ€§ API
                if ('serial' in navigator || 'hid' in navigator) {
                    return true;
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        async function tryAlternativeMethods() {
            log('å°è¯•å¤‡ç”¨æ–¹æ¡ˆ...', 'warning');
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šå¤‡ç”¨æ–¹æ¡ˆ
            updateStatus('å°è¯•å¤‡ç”¨æ–¹æ¡ˆ...');
            
            // å»¶è¿Ÿåæ˜¾ç¤ºæ¨¡æ‹Ÿé€‰é¡¹
            setTimeout(() => {
                updateOverlay('å¤‡ç”¨æ–¹æ¡ˆ', 'ç‚¹å‡»"æ¨¡æ‹Ÿè§†é¢‘æµ"æµ‹è¯•åŠŸèƒ½');
            }, 1000);
        }

        // ============== åˆå§‹åŒ– ==============
        window.addEventListener('load', () => {
            // è®¾ç½® Canvas å°ºå¯¸
            videoCanvas.width = window.innerWidth * 0.9;
            videoCanvas.height = videoCanvas.width * 9 / 16;
            
            // æ£€æµ‹æµè§ˆå™¨
            const isKiwi = detectBrowser();
            
            if (!isKiwi) {
                updateOverlay('æµè§ˆå™¨ä¸æ”¯æŒ', 'è¯·ä½¿ç”¨ Kiwi Browser');
                document.getElementById('connectBtn').disabled = true;
            }
            
            log('é¡µé¢åˆå§‹åŒ–å®Œæˆ', 'info');
        });
    </script>
</body>
</html>
</html>
